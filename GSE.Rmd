---
title: "Generally Applicable Gene-set Enrichment (GAGE)"
author: "Oliver Hölsken"
date: "12.12.2021"
output:
  html_document: default
  pdf_document: default
  github_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The github repository can be found [here](https://github.com/ohoelske/MDS_KW4_GSE)

# Set up Working environment

## Installations
```{r, message=FALSE,warning=FALSE}
if(!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install(version = "3.14")
```

```{r, message=FALSE,warning=FALSE}
#BiocManager::install(c("gage", "org.Hs.eg.db", "clusterProfiler"))
```

```{r, message=FALSE,warning=FALSE}
#install.packages("msigdbr")
```

## Load libraries
```{r,  message=FALSE,warning=FALSE}
library(BiocManager)
library(ggplot2)
library(ggrepel)
library(dplyr)
library(tibble)
library(readr)
library(tidyr)
library(tidyverse)
library(msigdbr)
library(clusterProfiler)
library(fgsea)
library(gage)
library(org.Hs.eg.db)
```

## Tasks

### Part 1: Getting familiar with Gene-sets

The Hallmark get can be found [here](https://www.gsea-msigdb.org/gsea/msigdb/genesets.jsp?collection=H).

1. Download Hallmark gene-sets using the `msigdbr` R package.
```{r}
#Check available gene sets using msigdbr_collections()
msigdbr_collections()
```

```{r}
# get Human H (Hallmark) gene sets
h_gene_set <- msigdbr(species = "human", 
                      category = "H")
head(h_gene_set)
# get Human Reactome gene sets
r_gene_set <- msigdbr(species = "human", 
                      category = "C2",
                      subcategory = "CP:REACTOME")
head(h_gene_set)
head(r_gene_set)
```
2.	Look at Hallmark: check the number of gene-sets, number of genes per gene set…

```{r}
# Create a nested data (list-column of a data frame) 
n_h_gene_set <- h_gene_set %>%
  group_by(gs_name) %>%
  nest()
# Count no of rows = gene sets
nrow(n_h_gene_set)
```
The Hallmark Datasets contains 50 Gene-sets
```{r}
#Extract the Gene-set names 
Gene_set_name <- n_h_gene_set$gs_name
head(Gene_set_name)
```

```{r}
#Define no of Genes per Gene set by using the purrr::map function
Genes_per_Gene_set <- map_int(my_list, ~nrow(.))
```

```{r}
# Generate df
GS_genes <- data.frame(Gene_set_name, Genes_per_Gene_set)
head(GS_genes)
```

```{r}
knitr::kable(GS_genes,
caption = "Table with kable")
```

3.	Prepare a figure (e.g. barplot) showing the number of genes per gene set.
```{r}
#Transform data frame to remove "Hallmark" string
GS_genes$Gene_set_name <- 
  gsub("HALLMARK_","",as.character(GS_genes$Gene_set_name))
head(GS_genes)
```

```{r}
#Change factor lavels to order according to no of genes per Gene set
GS_genes$Gene_set_name <- factor(GS_genes$Gene_set_name, 
                                 levels = GS_genes$Gene_set_name
                                 [order(GS_genes$Genes_per_Gene_set)])
```

```{r fig.height=10, fig.width = 5, fig.align='center', fig.cap=Genes per gene-set}
#Create the Bar Plot
ggplot(GS_genes, aes(x = Gene_set_name, y = Genes_per_Gene_set)) + 
  theme_bw() + 
  geom_bar(stat = "identity") +
  coord_flip()
```
4. Convert the hallmark `data.frame` into a named list (to be used as “gsets” parameter with gage)
(For this, the `readList` function was used from the downloaded `.gmt` files. This is probably not the most elegant way but it served its purpose I hope.)
```{r}
#Read in Database information as List
hallmarks_symbols <- readList("h.all.v7.4.symbols.gmt")
hallmarks_entrez <- readList("h.all.v7.4.entrez.gmt")
```

5. Do the same with the `Reactome` database
```{r}
reactome_entrez <- readList("c2.cp.reactome.v7.4.entrez.gmt")
reactome_symbol <- readList("c2.cp.reactome.v7.4.symbols.gmt")
```


### Part 2: 

Now we are preparing the gene-expression data.

1.	Load the hallmark list you have created
```{r}
hallmark_list <- hallmarks_entrez
```

2.	Load the log2 TPM matrix.
```{r}
expr.data <- read.delim("TCGA_GBM_log2TPM.txt")
expr.data <- as.data.frame(expr.data)
head(expr.data)
```

```{r}
#convert the data.frame into a matrix as to speed up the computing
expr.data.matr <- as.matrix(expr.data)
str(expr.data.matr)
```
3. Check the overlap between the database and the genes within the RNA matrix

```{r}
head(hallmark_list[[1]]); head(rownames(expr.data.matr))
```
gene ID types are the same in the gene sets `hallmark_list` and expression data`expr.data.mat`

4.  Create an annotation `data.frame` from the column names of the RNA matrix (i.e. assign each sample to either primary, recurrent or normal condition).
```{r}
my_sample_col <- data.frame(condition = rep(c("Normal", "Primary", "Recurrent"), 
                                            c(5,5,5)))
row.names(my_sample_col) <- colnames(expr.data)
my_sample_col
```

```{r}
# Check if all rownames from annotated sample column are equal to colnames of the expression data
all(rownames(my_sample_col) == colnames(expr.data))
```
```{r}
head(expr.data)
```


5.	Calculate the average log2 foldchange between primary and normal, recurrent and normal, recurrent and primary.
```{r}
#calculate the mean for each gene per group
normal_mean <- apply(expr.data[,1:5],1, mean)
primary_mean <- apply(expr.data[,6:10],1, mean)
recurrent_mean <- apply(expr.data[,11:15],1, mean)
```

```{r}
#calculate the fold change between the groups
## Normal/Primary
foldchange_nor_primary <- normal_mean - primary_mean 
## Normal/Recurrent
foldchange_nor_recurrent <- normal_mean - recurrent_mean
## Primary/Recurrent
foldchange_pri_recurrent <- primary_mean - recurrent_mean
```

```{r}
hist(foldchange_nor_primary, 
     xlab = "log2 Fold Change (Normal vs Primary)")
```

```{r}
hist(foldchange_nor_recurrent, 
     xlab = "log2 Fold Change (Normal vs Recurrent)")
```

```{r}
hist(foldchange_pri_recurrent, 
     xlab = "log2 Fold Change (Primary vs Recurrent)")
```

```{r}
#Add log2FC for normal/tumor
expr.data.fc <- expr.data
expr.data.fc$log2FC_nor_pri <- foldchange_nor_primary
expr.data.fc$log2FC_nor_rec <- foldchange_nor_recurrent
expr.data.fc$log2FC_pri_recurrent <- foldchange_pri_recurrent
expr.data.fc <- rownames_to_column(expr.data.fc, var = "gene_ID")
# add Gene_Symbol
expr.data.fc$Gene_Symbol <- eg2sym(expr.data.fc$gene_ID) 
head(expr.data.fc)
```


```{r}
#Select genes, which are upregulated in expression matrix (normal vs. primary)
genes.up_pri_no <- subset(expr.data.fc, 
                          log2FC_nor_pri > 0, 
                          select = c("Gene_Symbol", "gene_ID"))
head(genes.up_pri_no)
```

```{r}
#Select genes, which are downregulated in expxression matrix (normal vs. primary)
genes.down_pri_no <- subset(expr.data.fc, 
                            log2FC_nor_pri < 0,
                            select = c("Gene_Symbol", "gene_ID"))
head(genes.down_pri_no)
```

```{r}
#Select genes, which are up/downregulated in epxression matrix (normal vs. recurrent)
## Upregulated
genes.up_nor_rec <- subset(expr.data.fc, 
                           log2FC_nor_rec >0, 
                           select = c("Gene_Symbol", "gene_ID"))
## down
genes.down_nor_rec <- subset(expr.data.fc, 
                           log2FC_nor_rec <0, 
                           select = c("Gene_Symbol", "gene_ID"))
#Select genes, which are up/downregulated in epxression matrix (primary vs. recurrent)
## Upregulated
genes.up_pri_rec <- subset(expr.data.fc, 
                           log2FC_pri_recurrent >0, 
                           select = c("Gene_Symbol", "gene_ID"))
## down
genes.down_pri_rec <- subset(expr.data.fc, 
                           log2FC_pri_recurrent <0, 
                           select = c("Gene_Symbol", "gene_ID"))
```


6. Use `Gage` (unpaired test) to identify differentially UP- and DOWN-regulated gene-sets (using `Hallmark` and `Reactome` gene-sets separately). Make the following comparisons: primary vs. normal, recurrent vs. normal, recurrent vs. primary.
```{r}
#Definition of gage inputs
cn <- colnames(expr.data)
normal <- grep('Normal',cn, ignore.case =T)
primary <- grep('Primary',cn, ignore.case =T)
recurrent <- grep('Recurrent',cn, ignore.case =T)
```

```{r}
#Hallmarks
gage_H_pri_no = gage(exprs = expr.data, 
                     gsets = hallmark_list, 
                     set.size=c(10,500), 
                     same.dir = TRUE, 
                     compare ="unpaired", 
                     ref = normal, 
                     samp = primary) 

gage_H_rec_no = gage(exprs = expr.data, 
                     gsets = hallmark_list, 
                     set.size=c(10,500), 
                     same.dir = TRUE, 
                     compare ="unpaired", 
                     ref = normal, 
                     samp = recurrent)

gage_H_pri_rec = gage(exprs = expr.data, 
                      gsets = hallmark_list, 
                      set.size=c(10,500), 
                      same.dir = TRUE, 
                      compare ="unpaired", 
                      ref = primary, 
                      samp = recurrent)
```

```{r}
#Reactome database
gage_R_pri_no = gage(exprs = expr.data, 
                     gsets = reactome_entrez, 
                     set.size=c(10,500), 
                     same.dir = TRUE, 
                     compare ="unpaired", 
                     ref = normal, 
                     samp = primary) 

gage_R_rec_no = gage(exprs = expr.data, 
                     gsets = reactome_entrez, 
                     set.size=c(10,500), 
                     same.dir = TRUE, 
                     compare ="unpaired", 
                     ref = normal, 
                     samp = recurrent)

gage_R_pri_rec = gage(exprs = expr.data, 
                      gsets = reactome_entrez, 
                      set.size=c(10,500), 
                      same.dir = TRUE, 
                      compare ="unpaired", 
                      ref = primary, 
                      samp = recurrent)
```


```{r}
#Determine the significant gene sets by using the sigGeneSetFunction.
no_pri_H.sig<-sigGeneSet(gage_H_pri_no, cutoff = 0.1)
no_rec_H.sig<-sigGeneSet(gage_H_rec_no, cutoff = 0.1)
pri_rec_H.sig<-sigGeneSet(gage_H_pri_rec, cutoff = 0.1)
#Do the same for the reactome dataset
no_pri_R.sig<-sigGeneSet(gage_R_pri_no, cutoff = 0.1)
no_rec_R.sig<-sigGeneSet(gage_R_rec_no, cutoff = 0.1)
pri_rec_R.sig<-sigGeneSet(gage_R_pri_rec, cutoff = 0.1)
```

```{r}
#Upregulated Gene sets Normal vs. Primary as data frame
df_no_pri_H.sig <- as.data.frame(no_pri_H.sig$greater)
df_no_pri_H.sig <- subset(df_no_pri_H.sig,
                          select = c("p.val","q.val","set.size"))
head(df_no_pri_H.sig)
```


```{r}
#Create annotated Hallmark list
library(purrr)
#Upregulated genes
intersect_up_genes <- function(x) intersect(x, up_genes)
annotated_hallmarks_up <- map(hallmark_list, intersect_up_genes)
#Downregulated genes
intersect_down_genes <- function(x) intersect(x, down_genes)
annotated_hallmarks_down  <- map(hallmark_list, intersect_down_genes)
```

```{r}
from_list <- t(map_dfc(annotated_hallmarks_up, ~length(.)))
nb_column <- as.data.frame(from_list)
colnames(nb_column)[colnames(nb_column ) == "V1"] <- "nb"
nb_column 
```




7. Annotate the significantly regulated gene-sets with genes (entrez IDs and symbols). Check org.Hs.eg.db R package.
```{r}
library("org.Hs.eg.db")
```

```{r}
#3 most upregulated pathways in Hallmarks data set
rownames(no_pri_H.sig$greater)[1:3]
```

```{r}
head(rownames(expr.data))
```

```{r}
expr.data.sym<-expr.data
```

```{r}
# Convert Entrez ID to Gene Symbol
data(egSymb)
expr.data.sym <- eg2sym(rownames(expr.data.sym))
head(expr.data.sym)
```


```{r}
#Upregulated genes Normal vs. Tumor
#add column Gene_ID
new_df_2 <- rownames_to_column(genes_normal_primary_up, var="Gene_ID") 
# add Gene_Symbol
new_df_2$Gene_Symbol <- eg2sym(new_df_2$Gene_ID) 
new_df_2
```


```{r}
#Create a data frame from the hallmark_list
n_h_gene_set
```






```{r}
gs <- unique(unlist(kegg.gs[rownames(gse16873.kegg.p$greater)[1:3]]))
essData=essGene(gs, gse16873, ref =hn, samp =dcis)
head(essData, 4)
```

8.	Visualise the most significant gene-sets (e.g. using barplots or heatmaps)
```{r}
for (gs in rownames(gse16873.kegg.p$greater)[1:3]) {
+ outname = gsub(" |:|/", "_", substr(gs, 10, 100))
+ outname = paste(outname, "all", sep=".")
+ geneData(genes = kegg.gs[[gs]], exprs = gse16873, ref = hn,
+ samp = dcis, outname = outname, txt = T, heatmap = T,
+ Colv = F, Rowv = F, dendrogram = "none", limit = 3, scatterplot = T)
+ }
```




```{r}
#write.table(gage_pri_no$greater, file = "gage_pri_no.greater.txt", sep = "\t")
```

```{r}
#write.table(rbind(gage_pri_no$greater, gage_pri_no$less, file = "gage_pri_no2.txt", sep = "\t"))
```




####### Enrichment ######

GSEA
1. Detect general trend without setting limit on differential genes
2. Kolmogorov-Smirnov-Test, multiple hypotheses testing correction 
3. MSigDB helps finding other related studies

GAGE (Generally Applicable Gene-set Enrichment) [@GAGE]
1. applies to datasets with any number of sample and is based on a parametric gene randomization procedure [@GAGE]
2. Uses log-based fold changes as per gene statistics
3. assumes gene set comes from a different distribution than the background and unses two-sample t-test to account for the gene set specificic variance as well as the background variance
4. adjusts for different experimental designs and sample sizes by decomposing roup-on group comparison into one-on-one comparisons between samples from different groups
- derives a global p-value using a meta-test on the p-values from these comparisons for each gene set
5. separates experimentally perturbed gene sets (from literature, single directions) and canonical pathways (from pathway databases, both directions)



### Run GAGE algorithm



#Define significant genes


## Barplots


## Heatmap


## Jaccard graph




# Useful links:
## Gage
<http://bioconductor.org/packages/release/bioc/html/gage.html>
## msigdbr
<https://cran.r-project.org/web/packages/msigdbr/vignettes/msigdbr-intro.html>
## single cell RNA seq GSEA
<https://www.nature.com/articles/s41467-020-15298-6>


#### Data set description

Data retrieved from the [TCBA database](https://www.cancer.gov/about-nci/organization/ccg/research/structural-genomics/tcga) and includes log2-normalized read counts of RNA-sequencing samples from Glioblastoma multiforme (GBM) patients or healthy control tissues. 

Tumor tissues were classified as "Primary" or "Recurrent". Control tissues were classified as being "Normal.".

I used the updated curated gene set collection Hallmark (H) from the [MSigDB databse](https://www.gsea-msigdb.org/gsea/msigdb/) (@Libzerzon et al.2015).

# Citations

```{r}
citation("gage")
citation("org.Hs.eg.db")
ciation("misgbdr")
```

# Session info

```{r}
sessionInfo()
```
